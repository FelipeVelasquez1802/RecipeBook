version: 2.1
jobs:
  build:
    docker:
      - image: circleci/android:api-30

    working_directory: ~/app

    environment:
      JVM_OPTS: -Xmx3200m

    steps:
      - checkout

      # Se daba permisos de ejecución a Gradle
      - run:
          name: Gradle Permissions
          command: chmod +x ./gradlew

      # Descarga e instala las dependencias de Gradle
      - run:
          name: Install Dependencies
          command: ./gradlew dependencies

  test:
    docker:
      - image: circleci/android:api-30

    working_directory: ~/app

    environment:
      JVM_OPTS: -Xmx3200m

    steps:
      - checkout

      # Se daba permisos de ejecución a Gradle
      - run:
          name: Gradle Permissions
          command: chmod +x ./gradlew

      # Ejecuta los tests de tu aplicación
      - run:
          name: Run Tests
          command: ./gradlew domain:test

  coverage:
    docker:
      - image: circleci/android:api-30

    working_directory: ~/app

    environment:
      JVM_OPTS: -Xmx3200m

    steps:
      - checkout

      # Se daba permisos de ejecución a Gradle
      - run:
          name: Gradle Permissions
          command: chmod +x ./gradlew

      # Ejecuta la coberura de tu aplicación
      - run:
          name: Run Tests
          command: ./gradlew domain:jacocoTestReport

      # Ejecuta la validación de la cobertura de tu aplicación
      - run:
          name: Run Tests
          command: ./gradlew domain:jacocoTestCoverageVerification

workflows:
  version: 2
  build_and_test:
    jobs:
      - build
      - test:
          requires:
            - build
      - coverage:
          requires:
            - test
